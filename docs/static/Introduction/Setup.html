<!DOCTYPE html>
<!--[if lt IE 7]>       <html class="no-js ie6 oldie" lang="en"> <![endif]-->
<!--[if IE 7]>          <html class="no-js ie7 oldie" lang="en"> <![endif]-->
<!--[if IE 8]>          <html class="no-js ie8 oldie" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->  <html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <title>Setup - DoctrineWatcher</title>
    <meta name="description" content="Allows to track changes on doctrine entities with an easy-to-use API." />
    <meta name="author" content="Daniel Sentker">
    <meta charset="UTF-8">
    <link rel="icon" href="../themes/daux/img/favicon-navy.png" type="image/x-icon">
    <!-- Mobile -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font -->
    <link href='https://fonts.googleapis.com/css?family=Roboto+Slab:400,100,300,700&subset=latin,cyrillic-ext,cyrillic' rel='stylesheet' type='text/css'>
    <!-- CSS -->
    <link href='../themes/daux/css/theme-navy.min.css' rel='stylesheet' type='text/css'>
    
    <!--[if lt IE 9]>
    <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
</head>
<body class="with-float ">
    <div class="Columns content">
    <aside class="Columns__left Collapsible">
        <button type="button" class="Button Collapsible__trigger">
            <span class="Collapsible__trigger--bar"></span>
            <span class="Collapsible__trigger--bar"></span>
            <span class="Collapsible__trigger--bar"></span>
        </button>

        <a class="Brand" href="../index.html">DoctrineWatcher</a>


        <div class="Collapsible__content">
            <!-- Navigation -->
            <ul class='Nav'><li class='Nav__item Nav__item--open has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Introduction</a><ul class='Nav'><li class='Nav__item '><a href="../Introduction/Background.html">Background</a></li><li class='Nav__item '><a href="../Introduction/Requirements_and_Installation.html">Requirements and Installation</a></li><li class='Nav__item Nav__item--active'><a href="../Introduction/Setup.html">Setup</a></li></ul></li><li class='Nav__item  has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Usage</a><ul class='Nav'><li class='Nav__item '><a href="../Usage/Entity_Preparements.html">Entity Preparements</a></li><li class='Nav__item '><a href="../Usage/Annotation_options.html">Annotation options</a></li></ul></li><li class='Nav__item  has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Formatter and Handler</a><ul class='Nav'><li class='Nav__item '><a href="../Formatter_and_Handler/Using_Value_formatters.html">Using Value formatters</a></li><li class='Nav__item  has-children'><a href="#" class="aj-nav folder"><i class="Nav__arrow">&nbsp;</i>Database - Writing and reading entity changes</a><ul class='Nav'><li class='Nav__item '><a href="../Formatter_and_Handler/Database_-_Writing_and_reading_entity_changes/Overview.html">Overview</a></li><li class='Nav__item '><a href="../Formatter_and_Handler/Database_-_Writing_and_reading_entity_changes/Fetching_Entity_logs.html">Fetching Entity logs</a></li><li class='Nav__item '><a href="../Formatter_and_Handler/Database_-_Writing_and_reading_entity_changes/Use_a_custom_database_handler.html">Use a custom database handler</a></li></ul></li><li class='Nav__item '><a href="../Formatter_and_Handler/Logging_Entity_changes.html">Logging Entity changes</a></li><li class='Nav__item '><a href="../Formatter_and_Handler/Create_custom_Update_handler.html">Create custom Update handler</a></li></ul></li></ul>

            <div class="Links">
                                    <hr/>
                                            <a href="https://github.com/dsentker/DoctrineWatcher" target="_blank">GitHub Repo</a>
                        <br />
                                            <a href="https://github.com/dsentker/DoctrineWatcher/issues" target="_blank">Help / Support / Bugs</a>
                        <br />
                                    
                                    <div class="CodeToggler">
                        <hr/>
                                                    <span class="CodeToggler__text">Code blocks</span>
                            <div class="ButtonGroup" role="group">
                                <button class="Button Button--default Button--small CodeToggler__button CodeToggler__button--hide">No</button>
                                <button class="Button Button--default Button--small CodeToggler__button CodeToggler__button--below">Below</button>
                                <button class="Button Button--default Button--small CodeToggler__button CodeToggler__button--float">Inline</button>
                            </div>
                                            </div>
                
                            </div>
        </div>
    </aside>
    <div class="Columns__right Columns__right--float">
        <div class="Columns__right__content">
            <div class="doc_content">
                <article class="Page">

    <div class="Page__header">
        <h1><a href="../Introduction/Background.html">Introduction</a> <svg class="Page__header--separator" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 477.175 477.175"><path d="M360.73 229.075l-225.1-225.1c-5.3-5.3-13.8-5.3-19.1 0s-5.3 13.8 0 19.1l215.5 215.5-215.5 215.5c-5.3 5.3-5.3 13.8 0 19.1 2.6 2.6 6.1 4 9.5 4 3.4 0 6.9-1.3 9.5-4l225.1-225.1c5.3-5.2 5.3-13.8.1-19z"/></svg> <a href="../Introduction/Setup.html">Setup</a></h1>
                <span style="float: left; font-size: 10px; color: gray;">
            Thursday, September 14, 2017 1:58 PM        </span>
                        <span style="float: right; font-size: 10px; color: gray;">
            <a href="https://github.com/dsentker/DoctrineWatcher/master/docs/markdown/00_Introduction\03_Setup.md" target="_blank">Edit on GitHub</a>
        </span>
            </div>


    <div class="s-content">
        <ul class="TableOfContents">
<li>
<p><a href="#page_Setup">Setup</a></p>
</li>
<li>
<p><a href="#page_Register-annotations">Register annotations</a></p>
<ul class="TableOfContents">
<li>
<p><a href="#page_Don-t-make-use-of-the-SimpleAnnotationReader">Don't make use of the SimpleAnnotationReader</a></p>
</li>
</ul>
</li>
</ul>
<h2 id="page_Setup">Setup</h2>
<p>When creating the entity manager, you have to pass the EventManger (provided by doctrine) as third parameter.</p>
<p>First, create a new instance for the event manager. This event manger has to listen to onFlush-Events:</p>
<pre><code class="language-php">$eventManager = new EventManager();
$eventManager-&gt;addEventListener(array(Events::onFlush), $listener);
</code></pre>
<p>The $listener must be the FlushListener provided by this package. The easiest way to create an instance is to call</p>
<pre><code class="language-php">$listener = \Watcher\EventListener\FlushListener::createWithHandler($handler);
</code></pre>
<p>This method expects an handler which is called when an entity change is detected. The handler must follow the \Watcher\UpdateHandler Interface. In this example, we use the DatabaseHandler, which writes the changes to a separate table. All you need is a new instance to \Watcher\UpdateHandler\DatabaseHandler;</p>
<h2 id="page_Register-annotations">Register annotations</h2>
<p><strong>Watcher</strong> works with custom annotations. Since these are unknown to doctrine, they must be registered. Call <code>Watcher::registerAnnotations();</code> once per runtime to register the annotations before you use your entity manager.</p>
<h3 id="page_Don-t-make-use-of-the-SimpleAnnotationReader">Don't make use of the SimpleAnnotationReader</h3>
<p><strong>Important:</strong> Doctrine only accepts custom annotations if the &quot;Simple mode&quot; is disabled. When you create your Doctrine Configuration, you have to use the AnnotationDriver to enable the package's own annotations:</p>
<pre><code class="language-php">$config = Setup::createAnnotationMetadataConfiguration($paths, $isDevMode);
$config-&gt;setMetadataDriverImpl(new AnnotationDriver(
    new CachedReader(new AnnotationReader(), new ArrayCache()),
    $paths
));``` 

***

### Setup example   
```php
// Create the flush listener with the DatabaseHandler
$handler = new DatabaseHandler();
$listener = FlushListener::createWithHandler($handler);

// Create the event manager
$eventManager = new EventManager();

// Map onFlush-events to your FlushListener
$eventManager-&gt;addEventListener(array(Events::onFlush), $listener);

// Optional: add the LoadListener to your event manager if you want to access changed fields directly from your entity (more on that later) 
$eventManager-&gt;addEventListener(array(Events::postLoad), new LoadListener());

// Obtain an entity manager - check doctrine docs if you get stuck
$dbParams = ...
$config = ...
$em = EntityManager::create($dbParams, $config, $eventManager);

Watcher::registerAnnotations();

// or, to simplify things:
$em = EntityManager::create($dbParams, $config, Watcher::createEventManager(new DatabaseHandler());
Watcher::registerAnnotations();
</code></pre>
<p>Now you are ready :)</p>
    </div>

        <nav>
        <ul class="Pager">
            <li class=Pager--prev><a href="../Introduction/Requirements_and_Installation.html">Previous</a></li>            <li class=Pager--next><a href="../Usage/Entity_Preparements.html">Next</a></li>        </ul>
    </nav>
    </article>

            </div>
        </div>
    </div>
</div>

    
    <!-- jQuery -->
    <script src="../themes/daux/js/jquery-1.11.3.min.js"></script>

    <!-- hightlight.js -->
    <script src="../themes/daux/js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>

    <!-- JS -->
    
    <script src="../themes/daux/js/daux.js"></script>

    
</body>
</html>
